local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local SoundService = game:GetService("SoundService")
local TweenService = game:GetService("TweenService")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Configuration
local RAINBOW_SPEED = 0.5 
local SPECTATE_HOMER_KEY = Enum.KeyCode.Z
local SPECTATE_PLAYER_KEY = Enum.KeyCode.V 
local EXIT_SPECTATE_KEY = Enum.KeyCode.N
local FULLBRIGHT_KEY = Enum.KeyCode.X
local SPEED_KEY = Enum.KeyCode.C
local TOGGLE_KEY = Enum.KeyCode.M 
local TELEPORT_KEY = Enum.KeyCode.H -- New Keybind
local HOLD_TIME_THRESHOLD = 0.21
local JUMP_HEIGHT = 50
local TOGGLE_SPEED = 21
local DEFAULT_SPEED = 16
local TARGET_TEAM_NAME = "Barts"
local ESP_TEAM_NAME = "Perished" 
local HOMER_TEAM_NAME = "Homer"
local PURPLE_ESP = Color3.fromRGB(170, 0, 255)
local FRIEND_COLOR = Color3.fromRGB(0, 255, 120) 

-- Sound IDs
local SOUNDS = {
    Homer = "rbxassetid://140404505414006",
    Bart = "rbxassetid://81779033550290",
    Fullbright = "rbxassetid://126429670805263",
    Error = "rbxassetid://131661013076677",
    Speed = "rbxassetid://87394660974741",
    Default = "rbxassetid://75265596188487",
    Load = "rbxassetid://120284943712335"
}

local function playSfx(id)
    local finalId = (id == "rbxassetid://" or id == nil) and SOUNDS.Default or id
    local s = Instance.new("Sound")
    s.SoundId = finalId
    s.Volume = 1
    s.Parent = SoundService
    s:Play()
    game:GetService("Debris"):AddItem(s, 3)
end

-- State & Caching
local BLACKLIST = {["deerxsx"] = true, ["riggedbart"] = true, ["noonieloafer"] = true, ["kiki"] = true}
local friendCache = {}
local homerIndex, playerIndex = 0, 0
local isSpectatingHomer, isSpectatingPlayer = false, false
local fullbrightEnabled, speedEnabled = false, false
local menuOpen = false 
local currentHomerModels, currentMiscModels, activeNotifications = {}, {}, {}
local vHoldStart, hasExitedViaHold = 0, false

local originalSettings = {
    Brightness = Lighting.Brightness,
    ClockTime = Lighting.ClockTime,
    GlobalShadows = Lighting.GlobalShadows
}

-- Friendship Helper
local function checkIfFriend(otherPlayer)
    if otherPlayer == localPlayer then return false end
    if friendCache[otherPlayer.UserId] ~= nil then return friendCache[otherPlayer.UserId] end
    
    friendCache[otherPlayer.UserId] = false 
    task.spawn(function()
        local success, isFriend = pcall(function()
            return localPlayer:IsFriendsWith(otherPlayer.UserId)
        end)
        if success then friendCache[otherPlayer.UserId] = isFriend end
    end)
    return false
end

-- Notification System
local function notify(title, text, soundOverride, duration)
    local finalSound = soundOverride or SOUNDS.Default
    local displayTime = duration or 3
    if title:lower():find("error") or text:lower():find("no bart") or text:lower():find("no homer") then finalSound = SOUNDS.Error end
    playSfx(finalSound)
    
    local sg = localPlayer.PlayerGui:FindFirstChild("GeminiNotifs") or Instance.new("ScreenGui", localPlayer.PlayerGui)
    sg.Name = "GeminiNotifs"; sg.DisplayOrder = 999; sg.ResetOnSpawn = false
    
    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 220, 0, 65); frame.Position = UDim2.new(1, 30, 0.85, 0)
    frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15); frame.BackgroundTransparency = 0.2
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

    local tl = Instance.new("TextLabel", frame)
    tl.Size = UDim2.new(1, -20, 0.4, 0); tl.Position = UDim2.new(0, 10, 0.15, 0)
    tl.BackgroundTransparency = 1; tl.TextColor3 = Color3.new(1, 1, 1)
    tl.Font = Enum.Font.SourceSansBold; tl.Text = title:upper(); tl.TextScaled = true

    local dl = Instance.new("TextLabel", frame)
    dl.Size = UDim2.new(1, -20, 0.35, 0); dl.Position = UDim2.new(0, 10, 0.55, 0)
    dl.BackgroundTransparency = 1; dl.TextColor3 = Color3.fromRGB(200, 200, 200)
    dl.Font = Enum.Font.SourceSans; dl.Text = text; dl.TextScaled = true

    table.insert(activeNotifications, 1, frame)
    local function updateStack()
        for i, v in ipairs(activeNotifications) do
            if v and v.Parent then v:TweenPosition(UDim2.new(1, -230, 0.85, -((i - 1) * 75)), "Out", "Quart", 0.3, true) end
        end
    end
    updateStack()

    task.spawn(function()
        local start = tick()
        while tick() - start < displayTime and frame and frame.Parent do
            tl.TextColor3 = Color3.fromHSV((tick() * 1.5) % 1, 0.7, 1)
            RunService.RenderStepped:Wait()
        end
        if frame and frame.Parent then
            frame:TweenPosition(UDim2.new(1, 30, frame.Position.Y.Scale, frame.Position.Y.Offset), "In", "Quart", 0.3, true)
            task.wait(0.3)
            for i, v in ipairs(activeNotifications) do if v == frame then table.remove(activeNotifications, i) break end end
            frame:Destroy(); updateStack()
        end
    end)
end

-- GUI CREATION
local mainGui = Instance.new("ScreenGui", localPlayer.PlayerGui)
mainGui.Name = "HomegaSystem"; mainGui.ResetOnSpawn = false

local toggleBtn = Instance.new("TextButton", mainGui)
toggleBtn.Name = "MenuToggle"
toggleBtn.Size = UDim2.new(0, 240, 0, 40)
toggleBtn.Position = UDim2.new(0.62, 1185, -0.053, 637) 
toggleBtn.AnchorPoint = Vector2.new(0.5, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(10, 10, 10); toggleBtn.BackgroundTransparency = 0.4
toggleBtn.Text = "H立MEGA MENU [M to Open]"
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.SourceSansBold; toggleBtn.TextSize = 18
Instance.new("UICorner", toggleBtn)
local btnStroke = Instance.new("UIStroke", toggleBtn); btnStroke.Thickness = 0.4

local infoFrame = Instance.new("Frame", mainGui)
infoFrame.Size = UDim2.new(0, 220, 0, 180) -- Increased size slightly for new label
infoFrame.Position = UDim2.new(1, 30, 0.5, -80) 
infoFrame.BackgroundColor3 = Color3.fromRGB(10, 10, 10); infoFrame.BackgroundTransparency = 0.4
Instance.new("UICorner", infoFrame)
local infoStroke = Instance.new("UIStroke", infoFrame); infoStroke.Thickness = 1

local infoLabel = Instance.new("TextLabel", infoFrame)
infoLabel.Size = UDim2.new(1, -20, 1, -20); infoLabel.Position = UDim2.new(0, 10, 0, 10)
infoLabel.BackgroundTransparency = 1; infoLabel.TextColor3 = Color3.new(1, 1, 1)
infoLabel.Font = Enum.Font.SourceSansBold; infoLabel.TextScaled = true; infoLabel.TextXAlignment = Enum.TextXAlignment.Left

local function toggleMenu()
    menuOpen = not menuOpen
    local targetPos = menuOpen and UDim2.new(1, -230, 0.5, -80) or UDim2.new(1, 30, 0.5, -80)
    TweenService:Create(infoFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = targetPos}):Play()
    local textTweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Linear)
    local fadeOut = TweenService:Create(toggleBtn, textTweenInfo, {TextTransparency = 1})
    local fadeIn = TweenService:Create(toggleBtn, textTweenInfo, {TextTransparency = 0})
    fadeOut:Play()
    fadeOut.Completed:Connect(function()
        toggleBtn.Text = menuOpen and "H立MEGA MENU" or "H立MEGA MENU [M to Open]"
        fadeIn:Play()
    end)
    playSfx(SOUNDS.Default)
end

-- Drag Logic
local dragging, dragInput, dragStart, startPos
local dragDistance = 0 
toggleBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true; dragDistance = 0; dragStart = input.Position; startPos = toggleBtn.Position
        input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        dragDistance = delta.Magnitude
        toggleBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
toggleBtn.MouseButton1Click:Connect(function() if dragDistance < 5 then toggleMenu() end end)

local function exitSpectate()
    isSpectatingHomer, isSpectatingPlayer = false, false
    homerIndex, playerIndex = 0, 0
    camera.CameraSubject = localPlayer.Character:FindFirstChildOfClass("Humanoid") or localPlayer
    notify("Spectate", "Back to Character")
end

-- Teleport Logic
local function teleportToHomerPart()
    local character = localPlayer.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    
    if rootPart then
        local target = nil
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") and obj.Name == "HomerPart" then
                target = obj
                break
            end
        end

        if target then
            rootPart.CFrame = target.CFrame * CFrame.new(0, 3, 0)
            notify("Teleport", "Teleported To Homer.", SOUNDS.Homer)
        else
            notify("Error", "No Homer Found.", SOUNDS.Error)
        end
    end
end

-- Keybinds
UserInputService.InputBegan:Connect(function(i, p)
    if p then return end
    if i.KeyCode == TOGGLE_KEY then toggleMenu()
    elseif i.KeyCode == TELEPORT_KEY then teleportToHomerPart()
    elseif i.KeyCode == SPECTATE_PLAYER_KEY then vHoldStart = tick(); hasExitedViaHold = false
    elseif i.KeyCode == SPEED_KEY then
        speedEnabled = not speedEnabled
        if localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then
            localPlayer.Character.Humanoid.WalkSpeed = speedEnabled and TOGGLE_SPEED or DEFAULT_SPEED
        end
        notify("Speed", speedEnabled and "Fast (21)" or "Normal (16)", SOUNDS.Speed)
    elseif i.KeyCode == Enum.KeyCode.Space then
        local char = localPlayer.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum and (hum:GetState() == Enum.HumanoidStateType.Jumping or hum:GetState() == Enum.HumanoidStateType.Freefall) then
            char.HumanoidRootPart.Velocity = Vector3.new(0, JUMP_HEIGHT, 0)
        end
    elseif i.KeyCode == SPECTATE_HOMER_KEY then
        isSpectatingPlayer = false
        if #currentHomerModels > 0 then
            homerIndex = (homerIndex % (#currentHomerModels + 1)) + 1
            if homerIndex > #currentHomerModels then exitSpectate() else
                isSpectatingHomer = true
                local targetModel = currentHomerModels[homerIndex].Model
                camera.CameraSubject = targetModel:FindFirstChildOfClass("Humanoid") or targetModel
                notify("Homer View", "Watching: " .. targetModel.Name, SOUNDS.Homer)
            end
        else notify("Error", "No Homer(s) Found...") end
    elseif i.KeyCode == EXIT_SPECTATE_KEY then exitSpectate()
    elseif i.KeyCode == FULLBRIGHT_KEY then
        fullbrightEnabled = not fullbrightEnabled
        notify("Fullbright", fullbrightEnabled and "Enabled" or "Disabled", SOUNDS.Fullbright)
    end
end)

UserInputService.InputEnded:Connect(function(i, p)
    if p or i.KeyCode ~= SPECTATE_PLAYER_KEY then return end
    if not hasExitedViaHold and (tick() - vHoldStart) < HOLD_TIME_THRESHOLD then
        isSpectatingHomer = false
        local bartsTeam = {}
        for _, plr in ipairs(Players:GetPlayers()) do 
            if plr ~= localPlayer and plr.Character and plr.Team and plr.Team.Name == TARGET_TEAM_NAME then table.insert(bartsTeam, plr) end 
        end
        if #bartsTeam > 0 then
            playerIndex = (playerIndex % (#bartsTeam + 1)) + 1
            if playerIndex > #bartsTeam then exitSpectate() else
                isSpectatingPlayer = true
                camera.CameraSubject = bartsTeam[playerIndex].Character:FindFirstChildOfClass("Humanoid")
                notify("Bart View", "Watching: " .. bartsTeam[playerIndex].Name, SOUNDS.Bart)
            end
        else notify("Error", "No Bart(s) Found...") end
    end
    vHoldStart = 0
end)

-- Object Scanner
task.spawn(function()
    while true do
        local homersFound, miscFound = {}, {}
        local bodyNames = {"Head", "Torso", "Left Arm", "Right Arm", "Left Leg", "Right Leg", "HumanoidRootPart"}
        
        pcall(function()
            for _, obj in ipairs(workspace:GetDescendants()) do
                if obj:IsA("BasePart") then
                    local nameLower = obj.Name:lower()
                    local parent = obj.Parent
                    
                    local function handleHomerVis(model)
                        for _, part in ipairs(model:GetDescendants()) do
                            if part:IsA("BasePart") then
                                local pName = part.Name:lower()
                                local isExcluded = pName:find("homerpart") or pName == "hitbox"
                                local targetVal = isExcluded and 1 or 0
                                part.Transparency = targetVal
                                
                                if not part:FindFirstChild("VisLock") then
                                    Instance.new("BoolValue", part).Name = "VisLock"
                                    part:GetPropertyChangedSignal("Transparency"):Connect(function()
                                        part.Transparency = targetVal
                                    end)
                                end
                            end
                        end
                    end

                    local function handleMiscVis(model)
                        for _, part in ipairs(model:GetDescendants()) do
                            if part:IsA("BasePart") then
                                part.Transparency = 0.99
                                if not part:FindFirstChild("VisLock") then
                                    Instance.new("BoolValue", part).Name = "VisLock"
                                    part:GetPropertyChangedSignal("Transparency"):Connect(function()
                                        part.Transparency = 0.99
                                    end)
                                end
                            end
                        end
                    end

                    if nameLower:find("homerpart") then
                        if parent:IsA("Model") and not BLACKLIST[parent.Name:lower()] then
                            local seen = false
                            for _, v in ipairs(homersFound) do if v.Model == parent then seen = true break end end
                            if not seen then 
                                table.insert(homersFound, {Model = parent, Part = obj}) 
                                handleHomerVis(parent)
                            end
                        end
                    else
                        for _, bName in ipairs(bodyNames) do
                            if nameLower == bName:lower() or nameLower:find(bName:lower()) then
                                if parent:IsA("Model") and not BLACKLIST[parent.Name:lower()] and not Players:GetPlayerFromCharacter(parent) and parent ~= localPlayer.Character then
                                    local seen = false
                                    for _, v in ipairs(miscFound) do if v.Model == parent then seen = true break end end
                                    if not seen then 
                                        table.insert(miscFound, {Model = parent}) 
                                        handleMiscVis(parent)
                                    end
                                end
                                break
                            end
                        end
                    end
                end
            end
        end)
        currentHomerModels, currentMiscModels = homersFound, miscFound
        task.wait(1.5)
    end
end)

-- Render Loop
RunService.RenderStepped:Connect(function()
    local rainbow = Color3.fromHSV((tick() * RAINBOW_SPEED) % 1, 0.8, 1)
    infoStroke.Color = rainbow
    btnStroke.Color = rainbow
    
    if vHoldStart > 0 and not hasExitedViaHold then
        if (tick() - vHoldStart) >= HOLD_TIME_THRESHOLD then hasExitedViaHold = true; exitSpectate() end
    end

    if fullbrightEnabled then Lighting.Brightness, Lighting.ClockTime, Lighting.GlobalShadows = 1.5, 14, false
    else Lighting.Brightness, Lighting.ClockTime, Lighting.GlobalShadows = originalSettings.Brightness, originalSettings.ClockTime, originalSettings.GlobalShadows end

    infoLabel.Text = string.format("[B] Fly Noclip\n[Z] Homer View\n[V] Bart View\n[H] Teleport To Homer\n[N] Quick Cam Exit\n[HOLD V] Exit View\n[C] Speedboost: %s\n[X] Fullbright: %s\n[M] Toggle Menu", speedEnabled and "FAST" or "NORM", fullbrightEnabled and "ON" or "OFF")

    local amIHomer = localPlayer.Team and localPlayer.Team.Name == HOMER_TEAM_NAME
    local espActive = (localPlayer.Team and localPlayer.Team.Name == ESP_TEAM_NAME) or isSpectatingPlayer

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local isBart = player.Team and player.Team.Name == TARGET_TEAM_NAME
            local isFriend = checkIfFriend(player)

            if (amIHomer or (isSpectatingPlayer and isBart)) then
                for _, part in ipairs(player.Character:GetDescendants()) do
                    if part:IsA("BasePart") then 
                        part.Transparency = 0.99 
                        if not part:FindFirstChild("VisLock") then
                             Instance.new("BoolValue", part).Name = "VisLock"
                             part:GetPropertyChangedSignal("Transparency"):Connect(function()
                                 if (amIHomer or (isSpectatingPlayer and isBart)) then part.Transparency = 0.99 end
                             end)
                        end
                    end
                end
            end

            if amIHomer and player.Character:FindFirstChild("HumanoidRootPart") then
                local h = player.Character:FindFirstChild("HomerVision") or Instance.new("Highlight", player.Character)
                h.Name = "HomerVision"; h.FillColor = Color3.new(1, 1, 1); h.FillTransparency = 0.5; h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                h.OutlineColor = isFriend and FRIEND_COLOR or Color3.new(1, 1, 1)
            else
                if player.Character:FindFirstChild("HomerVision") then player.Character.HomerVision:Destroy() end
            end

            local hb = player.Character:FindFirstChild("PurpleESP")
            if espActive and isBart then
                if not hb then hb = Instance.new("Highlight", player.Character); hb.Name = "PurpleESP"; hb.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop end
                hb.FillColor = isFriend and FRIEND_COLOR or PURPLE_ESP
                hb.OutlineColor = Color3.new(1,1,1); hb.FillTransparency = 0.5
            elseif hb then hb:Destroy() end
        end
    end

    for _, data in ipairs(currentHomerModels) do
        if data.Model and data.Model.Parent then
            local h = data.Model:FindFirstChild("HomerRGB") or Instance.new("Highlight", data.Model)
            h.Name = "HomerRGB"; h.FillColor = rainbow; h.OutlineColor = rainbow
            h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop; h.FillTransparency = 0.5
        end
    end

    for _, data in ipairs(currentMiscModels) do
        if data.Model and data.Model.Parent then
            local h = data.Model:FindFirstChild("PurpleESP")
            if espActive and not data.Model:FindFirstChild("HomerRGB") then
                if not h then h = Instance.new("Highlight", data.Model); h.Name = "PurpleESP"; h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop end
                h.FillColor = PURPLE_ESP; h.OutlineColor = rainbow; h.FillTransparency = 0.51
            elseif h then h:Destroy() end
        end
    end
end)

notify("H立MEGA MENU LOADED!", "Press M To Open The Info Interface. (MADE BY TEAVR)", SOUNDS.Load, 12)
